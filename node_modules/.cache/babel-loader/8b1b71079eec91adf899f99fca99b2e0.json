{"ast":null,"code":"var esc = require('xml-escape');\n\nvar strxml = require('strxml'),\n    tag = strxml.tag;\n\nmodule.exports = function tokml(geojson, options) {\n  options = options || {\n    documentName: undefined,\n    documentDescription: undefined,\n    name: 'name',\n    description: 'description',\n    simplestyle: false,\n    timestamp: 'timestamp'\n  };\n  return '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' + tag('kml', {\n    'xmlns': 'http://www.opengis.net/kml/2.2'\n  }, tag('Document', documentName(options) + documentDescription(options) + root(geojson, options)));\n};\n\nfunction feature(options, styleHashesArray) {\n  return function (_) {\n    if (!_.properties || !geometry.valid(_.geometry)) return '';\n    var geometryString = geometry.any(_.geometry);\n    if (!geometryString) return '';\n    var styleDefinition = '',\n        styleReference = '';\n\n    if (options.simplestyle) {\n      var styleHash = hashStyle(_.properties);\n\n      if (styleHash) {\n        if (geometry.isPoint(_.geometry) && hasMarkerStyle(_.properties)) {\n          if (styleHashesArray.indexOf(styleHash) === -1) {\n            styleDefinition = markerStyle(_.properties, styleHash);\n            styleHashesArray.push(styleHash);\n          }\n\n          styleReference = tag('styleUrl', '#' + styleHash);\n        } else if ((geometry.isPolygon(_.geometry) || geometry.isLine(_.geometry)) && hasPolygonAndLineStyle(_.properties)) {\n          if (styleHashesArray.indexOf(styleHash) === -1) {\n            styleDefinition = polygonAndLineStyle(_.properties, styleHash);\n            styleHashesArray.push(styleHash);\n          }\n\n          styleReference = tag('styleUrl', '#' + styleHash);\n        } // Note that style of GeometryCollection / MultiGeometry is not supported\n\n      }\n    }\n\n    var attributes = {};\n    if (_.id) attributes.id = _.id;\n    return styleDefinition + tag('Placemark', attributes, name(_.properties, options) + description(_.properties, options) + extendeddata(_.properties) + timestamp(_.properties, options) + geometryString + styleReference);\n  };\n}\n\nfunction root(_, options) {\n  if (!_.type) return '';\n  var styleHashesArray = [];\n\n  switch (_.type) {\n    case 'FeatureCollection':\n      if (!_.features) return '';\n      return _.features.map(feature(options, styleHashesArray)).join('');\n\n    case 'Feature':\n      return feature(options, styleHashesArray)(_);\n\n    default:\n      return feature(options, styleHashesArray)({\n        type: 'Feature',\n        geometry: _,\n        properties: {}\n      });\n  }\n}\n\nfunction documentName(options) {\n  return options.documentName !== undefined ? tag('name', options.documentName) : '';\n}\n\nfunction documentDescription(options) {\n  return options.documentDescription !== undefined ? tag('description', options.documentDescription) : '';\n}\n\nfunction name(_, options) {\n  return _[options.name] ? tag('name', esc(_[options.name])) : '';\n}\n\nfunction description(_, options) {\n  return _[options.description] ? tag('description', esc(_[options.description])) : '';\n}\n\nfunction timestamp(_, options) {\n  return _[options.timestamp] ? tag('TimeStamp', tag('when', esc(_[options.timestamp]))) : '';\n} // ## Geometry Types\n//\n// https://developers.google.com/kml/documentation/kmlreference#geometry\n\n\nvar geometry = {\n  Point: function (_) {\n    return tag('Point', tag('coordinates', _.coordinates.join(',')));\n  },\n  LineString: function (_) {\n    return tag('LineString', tag('coordinates', linearring(_.coordinates)));\n  },\n  Polygon: function (_) {\n    if (!_.coordinates.length) return '';\n\n    var outer = _.coordinates[0],\n        inner = _.coordinates.slice(1),\n        outerRing = tag('outerBoundaryIs', tag('LinearRing', tag('coordinates', linearring(outer)))),\n        innerRings = inner.map(function (i) {\n      return tag('innerBoundaryIs', tag('LinearRing', tag('coordinates', linearring(i))));\n    }).join('');\n\n    return tag('Polygon', outerRing + innerRings);\n  },\n  MultiPoint: function (_) {\n    if (!_.coordinates.length) return '';\n    return tag('MultiGeometry', _.coordinates.map(function (c) {\n      return geometry.Point({\n        coordinates: c\n      });\n    }).join(''));\n  },\n  MultiPolygon: function (_) {\n    if (!_.coordinates.length) return '';\n    return tag('MultiGeometry', _.coordinates.map(function (c) {\n      return geometry.Polygon({\n        coordinates: c\n      });\n    }).join(''));\n  },\n  MultiLineString: function (_) {\n    if (!_.coordinates.length) return '';\n    return tag('MultiGeometry', _.coordinates.map(function (c) {\n      return geometry.LineString({\n        coordinates: c\n      });\n    }).join(''));\n  },\n  GeometryCollection: function (_) {\n    return tag('MultiGeometry', _.geometries.map(geometry.any).join(''));\n  },\n  valid: function (_) {\n    return _ && _.type && (_.coordinates || _.type === 'GeometryCollection' && _.geometries && _.geometries.every(geometry.valid));\n  },\n  any: function (_) {\n    if (geometry[_.type]) {\n      return geometry[_.type](_);\n    } else {\n      return '';\n    }\n  },\n  isPoint: function (_) {\n    return _.type === 'Point' || _.type === 'MultiPoint';\n  },\n  isPolygon: function (_) {\n    return _.type === 'Polygon' || _.type === 'MultiPolygon';\n  },\n  isLine: function (_) {\n    return _.type === 'LineString' || _.type === 'MultiLineString';\n  }\n};\n\nfunction linearring(_) {\n  return _.map(function (cds) {\n    return cds.join(',');\n  }).join(' ');\n} // ## Data\n\n\nfunction extendeddata(_) {\n  return tag('ExtendedData', {}, pairs(_).map(data).join(''));\n}\n\nfunction data(_) {\n  return tag('Data', {\n    'name': _[0]\n  }, tag('value', {}, esc(_[1] ? _[1].toString() : '')));\n} // ## Marker style\n\n\nfunction hasMarkerStyle(_) {\n  return !!(_['marker-size'] || _['marker-symbol'] || _['marker-color']);\n}\n\nfunction markerStyle(_, styleHash) {\n  return tag('Style', {\n    'id': styleHash\n  }, tag('IconStyle', tag('Icon', tag('href', iconUrl(_)))) + iconSize(_));\n}\n\nfunction iconUrl(_) {\n  var size = _['marker-size'] || 'medium',\n      symbol = _['marker-symbol'] ? '-' + _['marker-symbol'] : '',\n      color = (_['marker-color'] || '7e7e7e').replace('#', '');\n  return 'https://api.tiles.mapbox.com/v3/marker/' + 'pin-' + size.charAt(0) + symbol + '+' + color + '.png';\n}\n\nfunction iconSize(_) {\n  return tag('hotSpot', {\n    'xunits': 'fraction',\n    'yunits': 'fraction',\n    'x': '0.5',\n    'y': '0.5'\n  }, '');\n} // ## Polygon and Line style\n\n\nfunction hasPolygonAndLineStyle(_) {\n  for (var key in _) {\n    if ({\n      \"stroke\": true,\n      \"stroke-opacity\": true,\n      \"stroke-width\": true,\n      \"fill\": true,\n      \"fill-opacity\": true\n    }[key]) return true;\n  }\n}\n\nfunction polygonAndLineStyle(_, styleHash) {\n  var lineStyle = tag('LineStyle', tag('color', hexToKmlColor(_['stroke'], _['stroke-opacity']) || 'ff555555') + tag('width', {}, _['stroke-width'] === undefined ? 2 : _['stroke-width']));\n  var polyStyle = '';\n\n  if (_['fill'] || _['fill-opacity']) {\n    polyStyle = tag('PolyStyle', tag('color', {}, hexToKmlColor(_['fill'], _['fill-opacity']) || '88555555'));\n  }\n\n  return tag('Style', {\n    'id': styleHash\n  }, lineStyle + polyStyle);\n} // ## Style helpers\n\n\nfunction hashStyle(_) {\n  var hash = '';\n  if (_['marker-symbol']) hash = hash + 'ms' + _['marker-symbol'];\n  if (_['marker-color']) hash = hash + 'mc' + _['marker-color'].replace('#', '');\n  if (_['marker-size']) hash = hash + 'ms' + _['marker-size'];\n  if (_['stroke']) hash = hash + 's' + _['stroke'].replace('#', '');\n  if (_['stroke-width']) hash = hash + 'sw' + _['stroke-width'].toString().replace('.', '');\n  if (_['stroke-opacity']) hash = hash + 'mo' + _['stroke-opacity'].toString().replace('.', '');\n  if (_['fill']) hash = hash + 'f' + _['fill'].replace('#', '');\n  if (_['fill-opacity']) hash = hash + 'fo' + _['fill-opacity'].toString().replace('.', '');\n  return hash;\n}\n\nfunction hexToKmlColor(hexColor, opacity) {\n  if (typeof hexColor !== 'string') return '';\n  hexColor = hexColor.replace('#', '').toLowerCase();\n\n  if (hexColor.length === 3) {\n    hexColor = hexColor[0] + hexColor[0] + hexColor[1] + hexColor[1] + hexColor[2] + hexColor[2];\n  } else if (hexColor.length !== 6) {\n    return '';\n  }\n\n  var r = hexColor[0] + hexColor[1];\n  var g = hexColor[2] + hexColor[3];\n  var b = hexColor[4] + hexColor[5];\n  var o = 'ff';\n\n  if (typeof opacity === 'number' && opacity >= 0.0 && opacity <= 1.0) {\n    o = (opacity * 255).toString(16);\n    if (o.indexOf('.') > -1) o = o.substr(0, o.indexOf('.'));\n    if (o.length < 2) o = '0' + o;\n  }\n\n  return o + b + g + r;\n} // ## General helpers\n\n\nfunction pairs(_) {\n  var o = [];\n\n  for (var i in _) {\n    if (_[i]) {\n      o.push([i, _[i]]);\n    } else {\n      o.push([i, '']);\n    }\n  }\n\n  return o;\n}","map":{"version":3,"sources":["/home/zhiguangda/ITS/deckgl/node_modules/@maphubs/tokml/index.js"],"names":["esc","require","strxml","tag","module","exports","tokml","geojson","options","documentName","undefined","documentDescription","name","description","simplestyle","timestamp","root","feature","styleHashesArray","_","properties","geometry","valid","geometryString","any","styleDefinition","styleReference","styleHash","hashStyle","isPoint","hasMarkerStyle","indexOf","markerStyle","push","isPolygon","isLine","hasPolygonAndLineStyle","polygonAndLineStyle","attributes","id","extendeddata","type","features","map","join","Point","coordinates","LineString","linearring","Polygon","length","outer","inner","slice","outerRing","innerRings","i","MultiPoint","c","MultiPolygon","MultiLineString","GeometryCollection","geometries","every","cds","pairs","data","toString","iconUrl","iconSize","size","symbol","color","replace","charAt","key","lineStyle","hexToKmlColor","polyStyle","hash","hexColor","opacity","toLowerCase","r","g","b","o","substr"],"mappings":"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","sourcesContent":["var esc = require('xml-escape');\nvar strxml = require('strxml'),\n    tag = strxml.tag;\n\nmodule.exports = function tokml(geojson, options) {\n\n    options = options || {\n        documentName: undefined,\n        documentDescription: undefined,\n        name: 'name',\n        description: 'description',\n        simplestyle: false,\n        timestamp: 'timestamp'\n    };\n\n    return '<?xml version=\"1.0\" encoding=\"UTF-8\"?>' +\n        tag('kml', {'xmlns': 'http://www.opengis.net/kml/2.2'},\n            tag('Document',\n                documentName(options) +\n                documentDescription(options) +\n                root(geojson, options)\n               ));\n};\n\nfunction feature(options, styleHashesArray) {\n    return function(_) {\n        if (!_.properties || !geometry.valid(_.geometry)) return '';\n        var geometryString = geometry.any(_.geometry);\n        if (!geometryString) return '';\n        \n        var styleDefinition = '',\n            styleReference = '';\n        if (options.simplestyle) {\n            var styleHash = hashStyle(_.properties);\n            if (styleHash) {\n                if (geometry.isPoint(_.geometry) && hasMarkerStyle(_.properties)) {\n                    if (styleHashesArray.indexOf(styleHash) === -1) {\n                        styleDefinition = markerStyle(_.properties, styleHash);\n                        styleHashesArray.push(styleHash);\n                    }\n                    styleReference = tag('styleUrl', '#' + styleHash);\n                } else if ((geometry.isPolygon(_.geometry) || geometry.isLine(_.geometry)) && \n                    hasPolygonAndLineStyle(_.properties)) {\n                    if (styleHashesArray.indexOf(styleHash) === -1) {\n                        styleDefinition = polygonAndLineStyle(_.properties, styleHash);\n                        styleHashesArray.push(styleHash);\n                    }\n                    styleReference = tag('styleUrl', '#' + styleHash);\n                }\n                // Note that style of GeometryCollection / MultiGeometry is not supported\n            }\n        }\n  \n        var attributes = {}\n        if (_.id) attributes.id = _.id\n        return styleDefinition + tag('Placemark',\n            attributes,\n            name(_.properties, options) +\n            description(_.properties, options) +\n            extendeddata(_.properties) +\n            timestamp(_.properties, options) +\n            geometryString +\n            styleReference);\n    };\n}\n\nfunction root(_, options) {\n    if (!_.type) return '';\n    var styleHashesArray = [];\n            \n    switch (_.type) {\n        case 'FeatureCollection':\n            if (!_.features) return '';\n            return _.features.map(feature(options, styleHashesArray)).join('');\n        case 'Feature':\n            return feature(options, styleHashesArray)(_);\n        default:\n            return feature(options, styleHashesArray)({\n                type: 'Feature',\n                geometry: _,\n                properties: {}\n            });\n    }\n}\n\nfunction documentName(options) {\n    return (options.documentName !== undefined) ? tag('name', options.documentName) : '';\n}\n\nfunction documentDescription(options) {\n    return (options.documentDescription !== undefined) ? tag('description', options.documentDescription) : '';\n}\n\nfunction name(_, options) {\n    return _[options.name] ? tag('name', esc(_[options.name])) : '';\n}\n\nfunction description(_, options) {\n    return _[options.description] ? tag('description', esc(_[options.description])) : '';\n}\n\nfunction timestamp(_, options) {\n    return _[options.timestamp] ? tag('TimeStamp', tag('when', esc(_[options.timestamp]))) : '';\n}\n\n// ## Geometry Types\n//\n// https://developers.google.com/kml/documentation/kmlreference#geometry\nvar geometry = {\n    Point: function(_) {\n        return tag('Point', tag('coordinates', _.coordinates.join(',')));\n    },\n    LineString: function(_) {\n        return tag('LineString', tag('coordinates', linearring(_.coordinates)));\n    },\n    Polygon: function(_) {\n        if (!_.coordinates.length) return '';\n        var outer = _.coordinates[0],\n            inner = _.coordinates.slice(1),\n            outerRing = tag('outerBoundaryIs', \n                tag('LinearRing', tag('coordinates', linearring(outer)))),\n            innerRings = inner.map(function(i) {\n                return tag('innerBoundaryIs', \n                    tag('LinearRing', tag('coordinates', linearring(i))));\n            }).join('');\n        return tag('Polygon', outerRing + innerRings);\n    },\n    MultiPoint: function(_) {\n        if (!_.coordinates.length) return '';\n        return tag('MultiGeometry', _.coordinates.map(function(c) {\n            return geometry.Point({ coordinates: c });\n        }).join(''));\n    },\n    MultiPolygon: function(_) {\n        if (!_.coordinates.length) return '';\n        return tag('MultiGeometry', _.coordinates.map(function(c) {\n            return geometry.Polygon({ coordinates: c });\n        }).join(''));\n    },\n    MultiLineString: function(_) {\n        if (!_.coordinates.length) return '';\n        return tag('MultiGeometry', _.coordinates.map(function(c) {\n            return geometry.LineString({ coordinates: c });\n        }).join(''));\n    },\n    GeometryCollection: function(_) {\n        return tag('MultiGeometry',\n            _.geometries.map(geometry.any).join(''));\n    },\n    valid: function(_) {\n        return _ && _.type && (_.coordinates ||\n            _.type === 'GeometryCollection' && _.geometries && _.geometries.every(geometry.valid));\n    },\n    any: function(_) {\n        if (geometry[_.type]) {\n            return geometry[_.type](_);\n        } else {\n            return '';\n        }\n    },\n    isPoint: function(_) {\n        return _.type === 'Point' ||\n        _.type === 'MultiPoint';\n    },\n    isPolygon: function(_) {\n        return _.type === 'Polygon' ||\n        _.type === 'MultiPolygon';\n    },\n    isLine: function(_) {\n        return _.type === 'LineString' ||\n        _.type === 'MultiLineString';\n    }\n};\n\nfunction linearring(_) {\n    return _.map(function(cds) { return cds.join(','); }).join(' ');\n}\n\n// ## Data\nfunction extendeddata(_) {\n    return tag('ExtendedData', {}, pairs(_).map(data).join(''));\n}\n\nfunction data(_) {\n    return tag('Data', {'name': _[0]}, tag('value', {}, esc(_[1] ? _[1].toString() : '')));\n}\n\n// ## Marker style\nfunction hasMarkerStyle(_) {\n    return !!(_['marker-size'] || _['marker-symbol'] || _['marker-color']);\n}\n\nfunction markerStyle(_, styleHash) {\n    return tag('Style', {'id': styleHash},\n            tag('IconStyle',\n                tag('Icon',\n                    tag('href', iconUrl(_)))\n                ) + iconSize(_)\n            );\n}\n\nfunction iconUrl(_) {\n    var size = _['marker-size'] || 'medium',\n        symbol = _['marker-symbol'] ? '-' + _['marker-symbol'] : '',\n        color = (_['marker-color'] || '7e7e7e').replace('#', '');\n\n    return 'https://api.tiles.mapbox.com/v3/marker/' + 'pin-' + size.charAt(0) +\n        symbol + '+' + color + '.png';\n}\n\nfunction iconSize(_) {\n    return tag('hotSpot', {\n        'xunits': 'fraction',\n        'yunits': 'fraction',\n        'x': '0.5',\n        'y': '0.5'\n    }, '');\n}\n\n// ## Polygon and Line style\nfunction hasPolygonAndLineStyle(_) {\n    for (var key in _) {\n        if ({\n            \"stroke\": true,\n            \"stroke-opacity\": true,\n            \"stroke-width\": true,\n            \"fill\": true,\n            \"fill-opacity\": true\n        }[key]) return true;\n    }\n}\n\nfunction polygonAndLineStyle(_, styleHash) {\n    var lineStyle = tag('LineStyle', tag('color', hexToKmlColor(_['stroke'], _['stroke-opacity']) || 'ff555555') +\n        tag('width', {}, _['stroke-width'] === undefined ? 2 : _['stroke-width'])\n    );\n    \n    var polyStyle = '';\n    \n    if (_['fill'] || _['fill-opacity']) {\n        polyStyle = tag('PolyStyle', \n            tag('color', {}, hexToKmlColor(_['fill'], _['fill-opacity']) || '88555555')\n        );\n    }\n    \n    return tag('Style', {'id': styleHash}, lineStyle + polyStyle);\n}\n\n// ## Style helpers\nfunction hashStyle(_) {\n    var hash = '';\n    \n    if (_['marker-symbol']) hash = hash + 'ms' + _['marker-symbol'];\n    if (_['marker-color']) hash = hash + 'mc' + _['marker-color'].replace('#', '');\n    if (_['marker-size']) hash = hash + 'ms' + _['marker-size'];\n    if (_['stroke']) hash = hash + 's' + _['stroke'].replace('#', '');\n    if (_['stroke-width']) hash = hash + 'sw' + _['stroke-width'].toString().replace('.', '');\n    if (_['stroke-opacity']) hash = hash + 'mo' + _['stroke-opacity'].toString().replace('.', '');\n    if (_['fill']) hash = hash + 'f' + _['fill'].replace('#', '');\n    if (_['fill-opacity']) hash = hash + 'fo' + _['fill-opacity'].toString().replace('.', '');\n    \n    return hash;\n}\n\nfunction hexToKmlColor(hexColor, opacity) {\n    if (typeof hexColor !== 'string') return '';\n    \n    hexColor = hexColor.replace('#', '').toLowerCase();\n    \n    if (hexColor.length === 3) {\n        hexColor = hexColor[0] + hexColor[0] + \n        hexColor[1] + hexColor[1] + \n        hexColor[2] + hexColor[2];\n    } else if (hexColor.length !== 6) {\n        return '';\n    }\n    \n    var r = hexColor[0] + hexColor[1];\n    var g = hexColor[2] + hexColor[3];\n    var b = hexColor[4] + hexColor[5];\n    \n    var o = 'ff';\n    if (typeof opacity === 'number' && opacity >= 0.0 && opacity <= 1.0) {\n        o = (opacity * 255).toString(16);\n        if (o.indexOf('.') > -1) o = o.substr(0, o.indexOf('.'));\n        if (o.length < 2) o = '0' + o;\n    }\n    \n    return o + b + g + r;\n}\n\n// ## General helpers\nfunction pairs(_) {\n    var o = [];\n    for (var i in _){\n        if(_[i]){\n            o.push([i, _[i]]);\n        }else{\n            o.push([i, '']);\n        }\n    }\n    return o;\n}"]},"metadata":{},"sourceType":"script"}